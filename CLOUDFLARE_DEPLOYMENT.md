# راهنمای استقرار Worker کلادفلر برای جمع‌آوری قیمت طلا

سلام! این راهنما برای اینکه بتونی پروژه جمع‌آوری قیمت طلات رو روی کلادفلر ورکرز مستقر کنی نوشته شده.

## چیزایی که نیاز داری

1. اکانت کلادفلر (رایگان کافیه)
2. Node.js روی سیستمت نصب باشه
3. GitHub Personal Access Token

## مراحل راه‌اندازی

### مرحله ۱: نصب Wrangler CLI

```bash
npm install -g wrangler
```

### مرحله ۲: لاگین تو کلادفلر

```bash
wrangler login
```

این دستور یه صفحه وب باز میکنه که باید وارد اکانت کلادفلرت بشی.

### مرحله ۳: تنظیم متغیرهای محیطی

باید GitHub token رو به عنوان یه secret اضافه کنی:

```bash
# برای production
wrangler secret put GITHUB_TOKEN

# برای staging (اختیاری)
wrangler secret put GITHUB_TOKEN --env staging
```

وقتی ازت token میخواد، همون GitHub Personal Access Token رو که ساختی بچسبون.

### مرحله ۴: تنظیم زمان‌بندی cron

تو فایل `wrangler.toml` میتونی زمان‌بندی رو تغییر بدی:

```toml
[triggers]
crons = ["* * * * *"]  # هر دقیقه (برای تست)
# crons = ["0 * * * *"]  # هر ساعت
# crons = ["*/5 * * * *"]  # هر ۵ دقیقه
```

### مرحله ۵: استقرار Worker

```bash
# استقرار روی production
wrangler deploy

# استقرار روی staging
wrangler deploy --env staging
```

## تست کردن

### تست دستی
بعد از استقرار، میتونی worker رو دستی تست کنی:

```bash
# URL worker رو از خروجی deploy بگیر، بعد:
curl https://your-worker-name.your-subdomain.workers.dev
```

### مشاهده لاگ‌ها
برای نظارت بر اجرای worker:

```bash
wrangler tail
```

## گزینه‌های پیکربندی

### زمان‌بندی‌های Cron
- `"* * * * *"` - هر دقیقه
- `"*/5 * * * *"` - هر ۵ دقیقه  
- `"0 * * * *"` - هر ساعت
- `"0 */6 * * *"` - هر ۶ ساعت
- `"0 0 * * *"` - روزی یکبار ساعت ۰۰:۰۰

### متغیرهای محیطی
- `GITHUB_TOKEN` - توکن گیت‌هابت (اجباری)

## نظارت

1. **داشبورد کلادفلر**: متریک‌ها و لاگ‌های worker رو چک کن
2. **گیت‌هاب**: به‌روزرسانی فایل‌های CSV رو نظارت کن
3. **لاگ‌های Worker**: از `wrangler tail` برای نظارت real-time استفاده کن

## بهینه‌سازی هزینه

طرح رایگان کلادفلر ورکرز شامل:
- ۱۰۰,۰۰۰ درخواست در روز
- ۱۰ میلی‌ثانیه CPU time در هر درخواست

پروژه ما راحت تو این محدودیت‌ها میمونه.

## رفع مشکل

### مشکلات رایج

1. **مشکلات GitHub Token**
   - مطمئن شو token مجوز `repo` داره
   - چک کن token منقضی نشده باشه
   - تایید کن که secret درست تنظیم شده

2. **Cron کار نمیکنه**
   - syntax کرون تو wrangler.toml رو چک کن
   - لاگ‌های worker رو برای ارور بررسی کن
   - مطمئن شو worker موفقیت‌آمیز deploy شده

3. **محدودیت API**
   - GitHub API محدودیت rate داره
   - در صورت نیاز فرکانس cron رو کم کن

### حالت Debug
برای فعال کردن لاگ debug، فایل `cloudflare-worker.js` رو ویرایش کن:

```javascript
const DEBUG = true;  // از false به true تغییر بده
```

بعد دوباره deploy کن:

```bash
wrangler deploy
```

## نکات مفید

- اول با فرکانس هر دقیقه تست کن، بعد که مطمئن شدی کار میکنه به هر ۵ دقیقه یا هر ساعت تغییرش بده
- تو داشبورد کلادفلر میتونی آمار استفاده رو ببینی
- اگه مشکلی پیش اومد، حتما لاگ‌ها رو نگاه کن
- GitHub token رو هیچ‌وقت تو کد قرار نده، همیشه از secret استفاده کن

موفق باشی! 🚀 